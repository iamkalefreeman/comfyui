
WORKDIR /
RUN set -xe && mkdir -p ${MODEL_DIR} ${DIFFUSION_DIR} ${CHECKPOINT_DIR} ${VAE_DIR} ${CLIP_DIR} ${UNET_DIR} ${LORA_DIR}

# Define a persistent temporary file path
ENV ARIA2C_TMP_FILE="/tmp/download.txt"

# --- Qwen Models & Components ---

# Download: qwen_image_edit_2509_fp8_e4m3fn.safetensors
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/Comfy-Org/Qwen-Image-Edit_ComfyUI/resolve/main/split_files/diffusion_models/qwen_image_edit_2509_fp8_e4m3fn.safetensors?download=true
  dir=${DIFFUSION_DIR}
  out=qwen_image_edit_2509_fp8_e4m3fn.safetensors
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# Download: qwen_image_vae.safetensors
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI/resolve/main/split_files/vae/qwen_image_vae.safetensors?download=true
  dir=${VAE_DIR}
  out=qwen_image_vae.safetensors
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# Download: qwen_2.5_vl_7b_fp8_scaled.safetensors
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/Comfy-Org/Qwen-Image_ComfyUI/resolve/main/split_files/text_encoders/qwen_2.5_vl_7b_fp8_scaled.safetensors?download=true
  dir=${CLIP_DIR}
  out=qwen_2.5_vl_7b_fp8_scaled.safetensors
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# Download: Qwen-Image-Lightning-4steps-V2.0.safetensors
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/lightx2v/Qwen-Image-Lightning/resolve/main/Qwen-Image-Lightning-4steps-V2.0.safetensors?download=true
  dir=${LORA_DIR}
  out=Qwen-Image-Lightning-4steps-V2.0.safetensors
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# --- Loras ---
# Download: qwen-image-edit-2509-multi-angles.safetensors
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/dx8152/Qwen-Edit-2509-Multiple-angles/resolve/main/%E9%95%9C%E5%A4%B4%E8%BD%AC%E6%8D%A2.safetensors?download=true
  dir=${LORA_DIR}
  out=qwen-image-edit-2509-multi-angles.safetensors
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# SAM2 model for segmentation
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/1038lab/sam2/resolve/main/sam2.1_hiera_large-fp16.safetensors?download=true
  dir=${MODEL_DIR}/sam2
  out=sam2.1_hiera_large-fp16.safetensors
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# GroundingDino model for object detection/segmentation
COPY --chown=root:root <<EOF "${ARIA2C_TMP_FILE}"
https://huggingface.co/1038lab/GroundingDINO/resolve/main/groundingdino_swinb_cogcoor.safetensors?download=true
  dir=${MODEL_DIR}/grounding-dino
  out=groundingdino_swinb_cogcoor.safetensors

https://huggingface.co/1038lab/GroundingDINO/resolve/main/GroundingDINO_SwinB.cfg.py?download=true
  dir=${MODEL_DIR}/grounding-dino
  out=GroundingDINO_SwinB.cfg.py
EOF
RUN set -xe && aria2c -i "${ARIA2C_TMP_FILE}" -j 4 --max-connection-per-server=10 && rm -f "${ARIA2C_TMP_FILE}"

# Download HF models
ENV HF_HUB_ENABLE_HF_TRANSFER=1
RUN <<EOS
set -xe
pip install --no-cache-dir huggingface_hub "huggingface_hub[cli]" "huggingface_hub[hf_transfer]"
python3 -c "from huggingface_hub import snapshot_download; snapshot_download(repo_id='bert-base-uncased', repo_type='model', allow_patterns=['*.safetensors', '*.json', '*.txt', '*.py'])"
EOS
ENV HF_HUB_OFFLINE=1

# Copy local models
COPY ./models/MEXX_QWEN_TG300_23.safetensors ${LORA_DIR}/
COPY ./models/consistenceEditV2.WOzE.safetensors ${LORA_DIR}/
COPY ./models/qwenMysticxxxV1.rkUk.safetensors ${LORA_DIR}/
COPY ./models/clothesTryonQwenEdit.safetensors ${LORA_DIR}/
COPY ./models/extractOutfitV3.safetensors ${LORA_DIR}/
COPY ./models/poseTransferV2Qwen.safetensors ${LORA_DIR}/

